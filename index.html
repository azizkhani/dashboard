<!DOCTYPE HTML>
<meta name="viewport" content="width=device-width">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600" rel="stylesheet">
<style>
    html {
        text-align: right;
        font-family: 'Open Sans', sans-serif;
        font-size: 8vmin;
        font-style: normal;
        font-weight: 300;
        color: white;
        background: black;
        -webkit-font-smoothing: subpixel-antialiased;
        overflow: hidden;
    }
    #dayOfMonthOrdinal {
        font-size: 4vmin;
        vertical-align: super;
    }
    #timeColon {
        vertical-align: 1vmin;
    }
    .date {
        font-size: 6vmin;
    }
    .time {
        font-weight: 600;
        font-size: 26vmin;
        margin-top: -3vmin;
    }
    .weather {
        display: inline-block;
        text-align: center;
    }
    .forecast {
        position: relative;
        max-width: 70vmin;
        font-size: 14vmin;
        /* Leave space for icons. */
        padding-left: 24vmin;
        min-height: 24vmin;
    }
    .weather .forecast:not(:first-child) {
        margin-top: 4vmin;
    }
    .icon {
        width: 24vmin;
        height: 24vmin;
        position: absolute;
        left: 0;
        /* center vertically */
        top: 50%;
        transform: translate(0, -50%);
    }
    .temp {
        font-weight: 600;
    }
    .details {
        font-size: 3vmin;
        margin-top: -2vmin;
    }
</style>
<div class="date">
    <span id="day">Saturday</span>, <span id="month">Sep</span> <span id="dayOfMonth">10</span><span id="dayOfMonthOrdinal">st</span>
</div>
<div class="time">
    <span id="hour">5</span><span id="timeColon">:</span><span id="minute">21</span>
</div>
<div class="weather">
    <div id="current" class="forecast">
        <img class="icon">
        <span class="temp">70</span>
        <div class="details">Current: Unknown</div>
    </div>
    <div id="next" class="forecast">
        <img class="icon">
        <span class="temp">70</span>
        <div class="details">Next: Unknown</div>
    </div>
</div>
<script>
    var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    function dayOfWeekName(date) {
        return weekdays[date.getDay()];
    }

    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
    function monthName(date) {
        return months[date.getMonth()];
    }

    // Return the English ordinal for a number.
    function ordinal(number) {
        // The general pattern:
        //   number ends in 1 -> st (e.g., 31st)
        //   number ends in 2 -> nd (e.g., 32nd)
        //   number ends in 3 -> rd (e.g., 33rd)
        // 11, 12, and 13 are exceptions and just use 'th'.
        switch(number % 10) {
            case(1): if (number % 100 == 11) { break; } else { return 'st' };
            case(2): if (number % 100 == 12) { break; } else { return 'nd' };
            case(3): if (number % 100 == 13) { break; } else { return 'rd' };
        }
        return 'th';
    }

    function updateDateTime() {
        var date = new Date();

        day.innerText = dayOfWeekName(date);
        month.innerText = monthName(date);
        dayOfMonth.innerText = date.getDate();
        dayOfMonthOrdinal.innerText = ordinal(date.getDate());

        hour.innerText = date.getHours();
        // Make the colon white on even seconds, black on odd seconds.
        var colonVisible = date.getSeconds() % 2 === 0;
        timeColon.style.color = colonVisible ? 'white' : 'black';
        minute.innerText = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();

        // Fade the display at night.
        var fadeStartHours = 23;
        var fadeEndHours = 6;
        var fadedOpacity = 0.2;
        var fade = (date.getHours() >= fadeStartHours || date.getHours() <= fadeEndHours);
        document.body.style.opacity = fade ? fadedOpacity : 1;
    }

    // Callback with the current and next forecast for the given lat/lon. The forecasts
    // have a name, temperature, shortForecast (description), and icon.
    // This uses api.weather.gov, see: https://forecast-v3.weather.gov/documentation
    function getForecast(latitude, longitude, callback) {
        // Convert from the weather.gov icons (api.weather.gov/icons) to one of our svg icons.
        function updateIconUrl(forecastPeriod) {
            var iconUrlMap = {
                'skc': 'clear.svg',
                'few': 'mostlysunny.svg',
                'sct': 'partlycloudy.svg',
                'bkn': 'mostlycloudy.svg',
                'ovc': 'cloudy.svg',
                'wind_skc': 'clear.svg',
                'wind_few': 'mostlysunny.svg',
                'wind_sct': 'partlycloudy.svg',
                'wind_bkn': 'cloudy.svg',
                'wind_ovc': 'cloudy.svg',
                'snow': 'snow.svg',
                'rain_snow': 'sleet.svg',
                'rain_sleet': 'sleet.svg',
                'snow_sleet': 'sleet.svg',
                'fzra': 'sleet.svg',
                'rain_fzra': 'sleet.svg',
                'snow_fzra': 'sleet.svg',
                'sleet': 'sleet.svg',
                'rain': 'rain.svg',
                'rain_showers': 'rain.svg',
                'rain_showers_hi': 'rain.svg',
                'tsra': 'tstorms.svg',
                'tsra_sct': 'tstorms.svg',
                'tsra_hi': 'tstorms.svg',
                'tornado': 'unknown.svg',
                'hurr_warn': 'tstorms.svg',
                'hurr_watch': 'tstorms.svg',
                'ts_warn': 'tstorms.svg',
                'ts_watch': 'tstorms.svg',
                'ts_hurr_warn': 'tstorms.svg',
                'dust': 'hazy.svg',
                'smoke': 'hazy.svg',
                'haze': 'hazy.svg',
                'hot': 'clear.svg',
                'cold': 'clear.svg',
                'blizzard': 'snow.svg',
                'fog': 'fog.svg'
            };
            var icon = 'unknown.svg';
            for (var iconUrl in iconUrlMap) {
                if (forecastPeriod.icon.indexOf('/' + iconUrl) !== -1) {
                    icon = iconUrlMap[iconUrl];
                    break;
                }
            }
            forecastPeriod.icon = icon;
            return forecastPeriod;
        }

        var forecastUrl = 'https://api.weather.gov/points/' + latitude + ',' + longitude + '/forecast';
        var forecastRequest = new Request(forecastUrl);
        fetch(forecastRequest)
            .then(function(response) {
                return response.json();
            }).then(function(json) {
                var current = updateIconUrl(json.properties.periods[0]);
                var next = updateIconUrl(json.properties.periods[1]);
                callback(current, next);
            }).catch(function(error) {
                var errorForecast = {
                    name: 'Unknown',
                    temperature: '70',
                    shortForecast: 'Unknown',
                    icon: 'unknown.svg'
                };
                callback(errorForecast, errorForecast);
            });
    }

    function updateWeather() {
        var latitude = '37.7746088';
        var longitude = '-122.3957547';
        getForecast(latitude, longitude, function(currentForecast, nextForecast) {
            function updateForecastDom(forecastElement, forecast) {
                var iconElement = forecastElement.getElementsByClassName('icon')[0];
                iconElement.src = 'icons/' + forecast.icon;
                var tempElement = forecastElement.getElementsByClassName('temp')[0];
                tempElement.innerText = forecast.temperature + 'Â°';
                var detailsElement = forecastElement.getElementsByClassName('details')[0];
                detailsElement.innerText = forecast.name + ': ' + forecast.shortForecast;
            }

            updateForecastDom(document.getElementById('current'), currentForecast);
            updateForecastDom(document.getElementById('next'), nextForecast);
        });
    }

    window.setInterval(updateDateTime, 1000); // Update date&time once per second (1000ms).
    updateDateTime(); // Immediately update once so the date&time is correct for the first frame.
    window.setInterval(updateWeather, 3600000); // Update weather every hour (60*60*1000ms).
    updateWeather(); // Immediately update once so the weather is correct for the first frame.
    window.setInterval(function() { location.reload(); }, 86400000); // Refresh every day (24*60*60*1000ms).
</script>
