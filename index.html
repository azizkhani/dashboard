<!DOCTYPE HTML>
<meta name="viewport" content="width=device-width">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,600" rel="stylesheet">
<style>
    html {
        text-align: right;
        font-family: 'Open Sans', sans-serif;
        font-size: 8vmin;
        font-style: normal;
        font-weight: 300;
        color: white;
        background: black;
        -webkit-font-smoothing: subpixel-antialiased;
        overflow: hidden;
    }
    #dayOfMonthOrdinal {
        font-size: 4vmin;
        vertical-align: super;
    }
    #timeColon {
        vertical-align: 1vmin;
    }
    .date {
        font-size: 6vmin;
    }
    .time {
        font-weight: 600;
        font-size: 26vmin;
        margin-top: -3vmin;
    }
    .weather {
        display: inline-block;
        text-align: center;
    }
    .forecast {
        position: relative;
        max-width: 70vmin;
        font-size: 14vmin;
        /* Leave space for icons. */
        padding-left: 24vmin;
        min-height: 24vmin;
    }
    .weather .forecast:not(:first-child) {
        margin-top: 4vmin;
    }
    .forecastIcon {
        width: 24vmin;
        height: 24vmin;
        position: absolute;
        left: 0;
        /* center vertically */
        top: 50%;
        transform: translate(0, -50%);
    }
    .forecastTemp {
        font-weight: 600;
    }
    .forecastDetails {
        font-size: 3vmin;
        margin-top: -2vmin;
    }
</style>
<div class="date">
    <span id="day">Saturday</span>, <span id="month">Sep</span> <span id="dayOfMonth">10</span><span id="dayOfMonthOrdinal">st</span>
</div>
<div class="time">
    <span id="hour">5</span><span id="timeColon">:</span><span id="minute">21</span>
</div>
<div class="weather">
    <div id="current" class="forecast">
        <img class="forecastIcon">
        <span class="forecastTemp">70</span>
        <div class="forecastDetails">Current: Unknown</div>
    </div>
    <div id="next" class="forecast">
        <img class="forecastIcon">
        <span class="forecastTemp">70</span>
        <div class="forecastDetails">Next: Unknown</div>
    </div>
</div>
<script>
    var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    function dayOfWeekName(date) {
        return weekdays[date.getDay()];
    }

    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];
    function monthName(date) {
        return months[date.getMonth()];
    }

    // Return the English ordinal for a number.
    function ordinal(number) {
        // The general pattern:
        //   number ends in 1 -> st (e.g., 31st)
        //   number ends in 2 -> nd (e.g., 32nd)
        //   number ends in 3 -> rd (e.g., 33rd)
        // 11, 12, and 13 are exceptions and just use 'th'.
        switch(number % 10) {
            case(1): if (number % 100 == 11) { break; } else { return 'st' };
            case(2): if (number % 100 == 12) { break; } else { return 'nd' };
            case(3): if (number % 100 == 13) { break; } else { return 'rd' };
        }
        return 'th';
    }

    function updateDateTime() {
        var date = new Date();

        day.innerText = dayOfWeekName(date);
        month.innerText = monthName(date);
        dayOfMonth.innerText = date.getDate();
        dayOfMonthOrdinal.innerText = ordinal(date.getDate());

        hour.innerText = date.getHours();
        // Make the colon white on even seconds, black on odd seconds.
        var colonVisible = date.getSeconds() % 2 === 0;
        timeColon.style.color = colonVisible ? 'white' : 'black';
        minute.innerText = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();

        // Fade the display at night.
        var fadeStartHours = 23;
        var fadeEndHours = 6;
        var fadedOpacity = 0.2;
        var fade = (date.getHours() >= fadeStartHours || date.getHours() <= fadeEndHours);
        document.body.style.opacity = fade ? fadedOpacity : 1;
    }

    function parseForecast(forecast) {
        // Icon urls from https://api.weather.gov/icons
        var iconUrlMap = {
            'skc': 'clear.svg',
            'few': 'mostlysunny.svg',
            'sct': 'partlycloudy.svg',
            'bkn': 'mostlycloudy.svg',
            'ovc': 'cloudy.svg',
            'wind_skc': 'clear.svg',
            'wind_few': 'mostlysunny.svg',
            'wind_sct': 'partlycloudy.svg',
            'wind_bkn': 'cloudy.svg',
            'wind_ovc': 'cloudy.svg',
            'snow': 'snow.svg',
            'rain_snow': 'sleet.svg',
            'rain_sleet': 'sleet.svg',
            'snow_sleet': 'sleet.svg',
            'fzra': 'sleet.svg',
            'rain_fzra': 'sleet.svg',
            'snow_fzra': 'sleet.svg',
            'sleet': 'sleet.svg',
            'rain': 'rain.svg',
            'rain_showers': 'rain.svg',
            'rain_showers_hi': 'rain.svg',
            'tsra': 'tstorms.svg',
            'tsra_sct': 'tstorms.svg',
            'tsra_hi': 'tstorms.svg',
            'tornado': 'unknown.svg',
            'hurr_warn': 'tstorms.svg',
            'hurr_watch': 'tstorms.svg',
            'ts_warn': 'tstorms.svg',
            'ts_watch': 'tstorms.svg',
            'ts_hurr_warn': 'tstorms.svg',
            'dust': 'hazy.svg',
            'smoke': 'hazy.svg',
            'haze': 'hazy.svg',
            'hot': 'clear.svg',
            'cold': 'clear.svg',
            'blizzard': 'snow.svg',
            'fog': 'fog.svg'
        };
        var icon = 'unknown.svg';
        for (var iconUrl in iconUrlMap) {
            if (forecast.icon.indexOf('/' + iconUrl) !== -1) {
                icon = iconUrlMap[iconUrl];
                break;
            }
        }
        return {
            name: forecast.name,
            temperature: forecast.temperature,
            conditions: forecast.shortForecast,
            icon: icon
        };
    }

    function getForecast(callback) {
        var latitude = '37.7746088';
        var longitude = '-122.3957547';
        // See: https://forecast-v3.weather.gov/documentation
        var forecastUrl = 'https://api.weather.gov/points/' + latitude + ',' + longitude + '/forecast';
        var forecastRequest = new Request(forecastUrl);
        fetch(forecastRequest)
            .then(function(response) {
                return response.json();
            }).then(function(json) {
                callback({
                    current: parseForecast(json.properties.periods[0]),
                    next: parseForecast(json.properties.periods[1])
                });
            }).catch(function(error) {
                callback({
                    current: {
                        name: 'Current',
                        temperature: '70',
                        conditions: 'Unknown',
                        icon: 'unknown.svg'
                    },
                    next: {
                        name: 'Next',
                        temperature: '70',
                        conditions: 'Unknown',
                        icon: 'unknown.svg'
                    }
                });
            });
    }

    function updateWeather() {
        getForecast(function(forecast) {
            ['current', 'next'].forEach(function(period) {
                var forecastDay = document.getElementById(period);
                var icon = forecastDay.getElementsByClassName('forecastIcon')[0];
                icon.src = 'icons/' + forecast[period].icon;
                var temp = forecastDay.getElementsByClassName('forecastTemp')[0];
                temp.innerText = forecast[period].temperature + 'Â°';
                var details = forecastDay.getElementsByClassName('forecastDetails')[0];
                details.innerText = forecast[period].name + ': ' + forecast[period].conditions;
            });
        });
    }

    window.setInterval(updateDateTime, 1000); // Update date&time once per second (1000ms).
    updateDateTime(); // Immediately update once so the date&time is correct for the first frame.
    window.setInterval(updateWeather, 14400000); // Update weather every 4 hours (4*60*60*1000ms).
    updateWeather(); // Immediately update once so the weather is correct for the first frame.
    window.setInterval(function() { location.reload(); }, 86400000); // Refresh every day (24*60*60*1000ms).
</script>
