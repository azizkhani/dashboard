<!DOCTYPE HTML>
<meta name="viewport" content="width=device-width">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:300" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:500" rel="stylesheet">
<style>
    html {
        text-align: right;
        font-family: 'Roboto', sans-serif;
        font-size: 8vmin;
        font-style: normal;
        font-weight: 300;
        color: white;
        background: black;
        -webkit-font-smoothing: subpixel-antialiased;
    }
    #dayOfMonthOrdinal {
        font-size: 5vmin;
        vertical-align: super;
    }
    .time {
        font-weight: 500;
        font-size: 30vmin;
    }
    .temperature {
        padding-top: 10vmin;
        text-align: right;
        float: right;
    }
    .temperatureLabel {
        padding-right: 5vmin;
    }
    .wunderground {
        padding-top: 10vmin;
        /* The Wunderground API TOS requires attribution. */
        background-image: url('wundergroundLogo.png');
        background-position: bottom right;
        background-repeat: no-repeat;
        background-size: 90px auto;
        padding-bottom: 23px;
    }
    .forecastIcon {
        width: 15vmin;
        height: 15vmin;
        padding: 1vmin;
    }
    .forecastData {
        float: right;
    }
    .forecastDay {
        font-size: 3.3vmin;
    }
    .forecastHigh {
        font-size: 5vmin;
    }
    .forecastLow {
        font-size: 5vmin;
    }
</style>
<div class="date">
    <span id="day">Saturday</span>, <span id="month">Sep</span> <span id="dayOfMonth">10</span><span id="dayOfMonthOrdinal">st</span>
</div>
<div class="time">
    <span id="hour">5</span><span id="timeColon">:</span><span id="minute">21</span>
</div>
<div class="wunderground">
    <div id="today" class="forecast">
        <img id="forecastTodayIcon" class="forecastIcon">
        <div class="forecastData">
            <div id="forecastTodayDay" class="forecastDay"></div>
            <div class="forecastHigh">
                <span id="forecastTodayHighF"></span>&deg;F (<span id="forecastTodayHighC"></span>&deg;C)
            </div>
            <div class="forecastLow">
                <span id="forecastTodayLowF"></span>&deg;F (<span id="forecastTodayLowC"></span>&deg;C)
            </div>
        </div>
    </div>
    <div id="tomorrow" class="forecast">
        <img id="forecastTomorrowIcon" class="forecastIcon">
        <div class="forecastData">
            <div id="forecastTomorrowDay" class="forecastDay"></div>
            <div class="forecastHigh">
                <span id="forecastTomorrowHighF"></span>&deg;F (<span id="forecastTomorrowHighC"></span>&deg;C)
            </div>
            <div class="forecastLow">
                <span id="forecastTomorrowLowF"></span>&deg;F (<span id="forecastTomorrowLowC"></span>&deg;C)
            </div>
        </div>
    </div>
</div>
<script>
    function dayOfWeekName(date) {
        switch(date.getDay()) {
            case 0: return 'Sunday';
            case 1: return 'Monday';
            case 2: return 'Tuesday';
            case 3: return 'Wednesday';
            case 4: return 'Thursday';
            case 5: return 'Friday';
            default: return 'Saturday';
        }
    }

    function monthName(date) {
        switch(date.getMonth()) {
            case 0: return 'Jan';
            case 1: return 'Feb';
            case 2: return 'Mar';
            case 3: return 'Apr';
            case 4: return 'May';
            case 5: return 'Jun';
            case 6: return 'Jul';
            case 7: return 'Aug';
            case 8: return 'Sept';
            case 9: return 'Oct';
            case 10: return 'Nov';
            default: return 'Dec';
        }
    }

    // Credit for this ordinal code:
    // https://ecommerce.shopify.com/c/ecommerce-design/t/ordinal-number-in-javascript-1st-2nd-3rd-4th-29259
    var ordinals = ['th', 'st', 'nd', 'rd'];
    function ordinal(number) {
        var v = number % 100;
        return ordinals[(v-20)%10] || ordinals[v] || ordinals[0];
    }

    function updateDateTime() {
        var date = new Date();

        day.innerText = dayOfWeekName(date);
        month.innerText = monthName(date);
        dayOfMonth.innerText = date.getDate();
        dayOfMonthOrdinal.innerText = ordinal(date.getDate());

        hour.innerText = date.getHours();
        // Make the colon white on even seconds, black on odd seconds.
        var colonVisible = date.getSeconds() % 2 === 0;
        timeColon.style.color = colonVisible ? 'white' : 'black';
        minute.innerText = (date.getMinutes() < 10 ? '0' : '') + date.getMinutes();
    }

    // Use the Wunderground geoip service to lookup our location, falls back to new york.
    // This has been implemented as a function so the javascript geolocation API can be subbed in.
    function getLocation(callback) {
        var locationUrl = 'http://api.wunderground.com/api/' + wundergroundApiKey + '/geolookup/q/autoip.json';
        var locationRequest = new Request(locationUrl);
        fetch(locationRequest)
            .then(function(response) {
                return response.json();
            }).then(function(json) {
                var lat = json.location.lat;
                var lon = json.location.lon;
                callback({lat: lat, lon: lon});
            }).catch(function(error) {
                console.error('Could not determine location, falling back to New York, USA.');
                callback({lat: '40.730610', lon: '-73.935242'});
            });
    }

    function getForecast(location, callback) {
        var forecastUrl = 'http://api.wunderground.com/api/' + wundergroundApiKey + '/forecast/q/' + location.lat + ',' +location.lon + '.json';
        var forecastRequest = new Request(forecastUrl);
        fetch(forecastRequest)
            .then(function(response) {
                return response.json();
            }).then(function(json) {
                var today = json.forecast.simpleforecast.forecastday[0];
                var tomorrow = json.forecast.simpleforecast.forecastday[1];
                callback({
                    today: {
                        day: today.date.weekday,
                        highF: today.high.fahrenheit, highC: today.high.celsius,
                        lowF: today.high.fahrenheit, lowC: today.high.celsius,
                        icon: today.icon
                    },
                    tomorrow: {
                        day: tomorrow.date.weekday,
                        highF: tomorrow.high.fahrenheit, highC: tomorrow.high.celsius,
                        lowF: tomorrow.high.fahrenheit, lowC: tomorrow.high.celsius,
                        icon: tomorrow.icon
                    }
                });
            }).catch(function(error) {
                console.error('Could not determine weather, falling back to dummy data.');
                callback({
                    today: {
                        day: 'Someday',
                        highF: '0', highC: '0',
                        lowF: '0', lowC: '0',
                        icon: 'tstorms'
                    },
                    tomorrow: {
                        day: 'Someday',
                        highF: '0', highC: '0',
                        lowF: '0', lowC: '0',
                        icon: 'cloudy'
                    }
                });
            });
    }

    function updateWeather() {
        getLocation(function(location) {
            getForecast(location, function(forecast) {
                forecastTodayIcon.src = 'http://icons.wxug.com/i/c/k/' + forecast.today.icon + '.gif';
                forecastTodayDay.innerText = forecast.today.day;
                forecastTodayHighF.innerText = forecast.today.highF;
                forecastTodayHighC.innerText = forecast.today.highC;
                forecastTodayLowF.innerText = forecast.today.lowF;
                forecastTodayLowC.innerText = forecast.today.lowC;
                forecastTomorrowIcon.src = 'http://icons.wxug.com/i/c/k/' + forecast.tomorrow.icon + '.gif';
                forecastTomorrowDay.innerText = forecast.tomorrow.day;
                forecastTomorrowHighF.innerText = forecast.tomorrow.highF;
                forecastTomorrowHighC.innerText = forecast.tomorrow.highC;
                forecastTomorrowLowF.innerText = forecast.tomorrow.lowF;
                forecastTomorrowLowC.innerText = forecast.tomorrow.lowC;
            });
        });
    }

    window.setInterval(updateDateTime, 1000); // Update date&time once per second (1000ms).
    updateDateTime(); // Immediately update once so the date&time is correct for the first frame.
    var wundergroundApiKey = 'do_not_use_18dc12c420cff7c6'; // From https://www.wunderground.com/weather/api
    window.setInterval(updateWeather, 14400000); // Update weather every 4 hours (4*60*60*1000ms).
    updateWeather(); // Immediately update once so the weather is correct for the first frame.
</script>
